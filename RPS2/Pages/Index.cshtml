@page
@model IndexModel

<main>
    <!-- homepage (matchmaking) -->
    <section id="matchmaking" class="center" style="">
        <section style="text-align: center; padding:1px">
            <img src="images/Logo.svg" class="mb-5 logo" />
        </section>
        <section style="text-align:center; padding:1px" class="mt-5">
            <div class="d-flex justify-content-center mb-4">
                <input id="nameInput" type="text" class="form-control shadow-none" placeholder="Enter your name" maxlength="30">
            </div>
            <div class="d-flex justify-content-center">
                <input id="friendIdInput" type="text" class="form-control shadow-none" placeholder="Enter your friend's code*" maxlength="8">
            </div>
            <div class="d-flex justify-content-center mb-5">
                <label class="note">*optional: leave blank for automatic matchmaking</label>
            </div>
            <a id="findGameBtn" class="btn btn-primary mt-5">Find game &raquo;</a>
            <a id="fightAIBtn" class="btn btn-primary mt-5">VS AI</a>

            <div class="d-flex justify-content-end me-5">
                <div style="flex-direction: column; display:flex">
                    <img src="images/play_with_friend.svg" class="play-friends" />
                    <div>
                        <a id="GUID" class="btn btn-primary mt-3">
                            <span id="GUID-TEXT">
                            </span>
                            <img src="images/copy_icon.svg" class="ms-3" style="text-align:right; height:2rem; width: auto" />
                        </a>
                    </div>
                </div>
            </div>
        </section>
    </section>

    <!-- searching -->
    <section id="searching" class="center" style="display:none">
        <section style="text-align: center; padding:1px">
            <img src="images/Logo.svg" class="logo" />
        </section>
        <section style="text-align:center; padding:1px" class="mt-5 mb-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </section>
        <section style="text-align: center; padding:1px">
            <label id="waitingQuip" class="waiting-text"></label>
        </section>
        <section id="searchingCodeButton" style="text-align: center; padding:1px">
            <a id="GUID-2" class="btn btn-primary mt-5">
                <span id="GUID-TEXT-2">
                    asdfasdf
                </span>
                <img src="images/copy_icon.svg" class="ms-3" style="text-align:right; height:2rem; width: auto" />
            </a>
        </section>
        <section id="searchingCodeLabel" style="text-align: center; padding:1px">
            <label class="friend-note">Still waiting? Share your code again!</label>
        </section>
    </section>

    <!-- results -->
    <section id="results" class="center" style="display:none">
        <section style="text-align: center; padding:1px">
            <img src="images/Logo.svg" class="logo" />
        </section>
        <section style="text-align: center; padding:1px">
            <img id="resultsImage" src="images/win.svg" class="results-image mt-5" />
        </section>
        <section style="text-align: center; padding:1px">
            <a id="playAgainBtn" class="btn btn-primary mt-3 mb-5 play-again-btn">Play again?</a>
        </section>
        <section style="text-align: center; padding:1px">
            <label class="note" style="text-align:center !important">Enjoyed Rock Paper Scissors 2v2? Make sure to check out these other fun games!</label>
        </section>
        <section style="text-align: center; padding:1px">
            <div class="d-flex justify-content-center">
                <a href="https://store.steampowered.com/app/3107360/Grooveyard/" rel="noopener noreferrer" target="_blank" class="btn btn-primary mt-1 wishlist-btn me-3">Wishlist Grooveyard on Steam</a>
                <a href="https://store.steampowered.com/app/2441100/Unrooted/" rel="noopener noreferrer" target="_blank" class="btn btn-primary mt-1 wishlist-btn ms-3">Check out Unrooted on Steam</a>
            </div>
        </section>
    </section>

    <!-- gameplay -->
    <section id="game" style="display:none">
        <div class="container">
            <div class="top-row">
                <div class="d-flex justify-content-center">
                    <div class="d-flex align-items-center flex-column">
                        <span id="partnerName" class="player-name-top">
                            Friend
                        </span>
                        <div class="choose-item-invis">
                            <div id="partnerChoiceDiv" class="item">
                                <div id="partnerChoiceWait" class="spinner-border spinner-card" role="status" style="display:none">
                                </div>
                                <img id="partnerChoice" src="images/checkmark_icon.svg" style="" />
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <section style="text-align: center;">
                        <h1 id="round" class="round-text">Round 1</h1>
                    </section>
                    <section style="text-align: center;">
                        <h1 id="countdown" class="countdown">00:10</h1>
                    </section>
                </div>
                <div class="d-flex justify-content-center">
                    <div class="d-flex align-items-center flex-column">
                        <span id="selfEnemyName" class="player-name-top">
                            Enemy1
                        </span>
                        <div class="choose-item-invis">

                            <div id="partnerEnemyChoiceDiv" class="item">
                                <div id="partnerEnemyChoiceWait" class="spinner-border spinner-card" role="status" style="display:none">
                                </div>
                                <img id="partnerEnemyChoice" src="images/checkmark_icon.svg" style="" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div></div>

            <div class="middle-row">
                <div class="star-container">
                    <img id="team_star_1" src="images/star_empty.svg" class="star" style="display:unset" />
                    <img id="team_star_2" src="images/star_empty.svg" class="star" style="display:unset" />

                </div>
                <div class="star-container">
                    <img id="enemy_star_1" src="images/star_empty.svg" class="star" style="display:unset" />
                    <img id="enemy_star_2" src="images/star_empty.svg" class="star" style="display:unset" />
                </div>
            </div>

            <div class="bottom-row">
                <div class="d-flex justify-content-center">
                    <div class="d-flex align-items-center flex-column">
                        <!-- choice selection -->
                        <div id="chooseItem" class="choose-item">
                            <img id="rockChoice" src="images/rock.svg" />
                            <img id="paperChoice" src="images/paper.svg" />
                            <img id="scissorsChoice" src="images/scissors.svg" />
                        </div>
                        <div id="selfChoiceDiv" class="choose-item-invis" style="display:none !important">
                            <div id="selfChoiceItemDiv" class="item">
                                <img id="selfChoice" src="images/rock.svg" />
                            </div>
                        </div>
                        <span class="player-name-bottom">
                            You!
                        </span>
                    </div>
                </div>
                <div></div>
                <div class="d-flex justify-content-center">
                    <div class="d-flex align-items-center flex-column">
                        <div id="selfEnemyChoiceDiv" class="choose-item-invis">
                            <div class="item">
                                <div id="selfEnemyChoiceWait" class="spinner-border spinner-card" role="status" style="display:none">
                                </div>
                                <img id="selfEnemyChoice" src="images/checkmark_icon.svg" />
                            </div>
                        </div>
                        <span id="partnerEnemyName" class="player-name-bottom">
                            Enemy2
                        </span>
                    </div>
                </div>
            </div>
            <svg id="selfLineSVG" width="500" height="500" style="position: absolute; pointer-events: none;"><line id="selfLine" x1="250" y1="500" x2="1000" y2="500" stroke="white" stroke-width="3" /></svg>
            <svg id="partnerLineSVG" width="500" height="500" style="position: absolute; pointer-events: none;"><line id="partnerLine" x1="250" y1="500" x2="1000" y2="500" stroke="white" stroke-width="3" /></svg>
        </div>
    </section>

    <!-- results -->
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.0/signalr.min.js"></script>
<script>
    let quips = ["Scissors at the ready", "Avalanche incoming", "Paper uncovered"];
    let moveOptions = ["rock", "paper", "scissors"];

    // gamestate
    // player order: self, selfEnemy, partner, partnerEnemy
    let playerChoices = [0, 0, 0, 0];
    let playersAlive = [true, true, true, true];
    let lineDivs = [];
    let res1 = 0;
    let res2 = 0;
    let roundSecondsRemaining = 0;
    let resultsSecondsRemaining = 0;
    let aiMode = false;
    let teamWins = 0;
    let enemyWins = 0;
    let starsToWin = 2;
    let playerMap = {}
    let moveChosen = false;
    let ticking = false;

    friendIdInput.addEventListener('input', function () {
        // restrict friend code input to alphanum
        this.value = this.value.replace(/[^a-zA-Z0-9-_]/g, '');

        // tether 'find game' button state to friend code input validity
        if (this.value.length == 0 || this.value.length == 8) {
            document.getElementById("findGameBtn").style = "";
        }
        else {
            document.getElementById("findGameBtn").style = "pointer-events: none; color: gray;";
        }
    });

    // create the SignalR connection
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/gamehub")
        .build();
    startConnection();

    function startConnection() {
        connection.start()
            .then(() => {
                console.log("SignalR connected");

                // display guid
                document.getElementById('GUID-TEXT').innerText = `${connection.connectionId.substring(0, 8)}`;
                document.getElementById('GUID-TEXT-2').innerText = `${connection.connectionId.substring(0, 8)}`;
            })
            .catch(err => console.error("Error while starting SignalR connection: " + err));
    }

    function startNextRound() {

        if (playersAlive[0]) {
            document.getElementById('chooseItem').style.setProperty('display', 'flex', 'important');
            document.getElementById('selfChoiceDiv').style.setProperty('display', 'none', 'important');
            moveChosen = false;
        }
        else {
            document.getElementById('selfChoice').src = "images/skull_icon.svg"
            // TODO: might need to make death calculations serverside logic to avoid cheating
            connection.invoke("SubmitMove", "die")
                .catch(err => console.error("Error submitting action: " + err));
        }

        if (playersAlive[2]) {
            document.getElementById("partnerChoiceWait").style.setProperty('display', 'unset', 'important');
            document.getElementById("partnerChoice").style.setProperty('display', 'none', 'important');
        }
        else {
            document.getElementById('partnerChoice').src = "images/skull_icon.svg"
        }

        if (playersAlive[3]) {
            document.getElementById("partnerEnemyChoiceWait").style.setProperty('display', 'unset', 'important');
            document.getElementById("partnerEnemyChoice").style.setProperty('display', 'none', 'important');
        }
        else {
            document.getElementById('partnerEnemyChoice').src = "images/skull_icon.svg"
        }

        if (playersAlive[1]) {
            document.getElementById("selfEnemyChoiceWait").style.setProperty('display', 'unset', 'important');
            document.getElementById("selfEnemyChoice").style.setProperty('display', 'none', 'important');
        }
        else {
            document.getElementById('selfEnemyChoice').src = "images/skull_icon.svg"
        }

        positionLines();
        clearLineColors();

        // countdown
        roundSecondsRemaining = 10;

        // if aiMode and you are dead, don't make you wait
        if (!playersAlive[0] && aiMode) {
            roundSecondsRemaining = 2;
        }

        document.getElementById('countdown').textContent = "00:" + String(roundSecondsRemaining).padStart(2, '0');
        document.getElementById('countdown').style.color = roundSecondsRemaining > 5 ? "white" : roundSecondsRemaining > 3 ? "orange" : "red";
        countdownInterval = setInterval(() => {
            if (roundSecondsRemaining > 0) {
                --roundSecondsRemaining;
                document.getElementById('countdown').textContent = "00:" + String(roundSecondsRemaining).padStart(2, '0');
                document.getElementById('countdown').style.color = roundSecondsRemaining > 5 ? "white" : roundSecondsRemaining > 3 ? "orange" : "red";
            }
            // countdown finished, in aimode show next round, otherwise wait for server
            if (roundSecondsRemaining === 0) {
                if (aiMode) {
                    makeAiChoices();
                    revealChoices();
                }
            }
        }, 1000);

        if (aiMode) {
            // ready all 3 bots immediately
            // in future just move these to "movereceived";
            if (playersAlive[2]) {
                document.getElementById("partnerChoice").src = "images/checkmark_icon.svg";
                document.getElementById("partnerChoiceWait").style.setProperty('display', 'none', 'important');
                document.getElementById("partnerChoice").style.setProperty('display', 'flex', 'important');
            }

            if (playersAlive[3]) {
                document.getElementById("partnerEnemyChoice").src = "images/checkmark_icon.svg";
                document.getElementById("partnerEnemyChoiceWait").style.setProperty('display', 'none', 'important');
                document.getElementById("partnerEnemyChoice").style.setProperty('display', 'flex', 'important');
            }

            if (playersAlive[1]) {
                document.getElementById("selfEnemyChoice").src = "images/checkmark_icon.svg";
                document.getElementById("selfEnemyChoiceWait").style.setProperty('display', 'none', 'important');
                document.getElementById("selfEnemyChoice").style.setProperty('display', 'flex', 'important');
            }
        }
    }

    // res: -1 = loss, 0 = tie, 1 = win
    function GetRPSResult(a, b) {
        // rock
        if (a == 0)
            return b == 0 ? 0 : b == 1 ? -1 : 1;
        // paper
        if (a == 1)
            return b == 0 ? 1 : b == 1 ? 0 : -1;
        // scissors
        return b == 0 ? -1 : b == 1 ? 1 : 0;
    }

    function revealChoices() {
        // Clear countdown interval
        clearInterval(countdownInterval);
        countdownInterval = null;

        // Update countdown text
        document.getElementById('countdown').textContent = 'Results';
        document.getElementById('countdown').style.color = "white";

        document.getElementById("partnerChoiceWait").style.setProperty('display', 'none', 'important');
        document.getElementById("partnerChoice").style.setProperty('display', 'flex', 'important');

        document.getElementById("partnerEnemyChoiceWait").style.setProperty('display', 'none', 'important');
        document.getElementById("partnerEnemyChoice").style.setProperty('display', 'flex', 'important');

        document.getElementById("selfEnemyChoiceWait").style.setProperty('display', 'none', 'important');
        document.getElementById("selfEnemyChoice").style.setProperty('display', 'flex', 'important');

        // reveal player choices
        if (playersAlive[2])
            document.getElementById('partnerChoice').src = "images/" + moveOptions[playerChoices[2]] + ".svg"

        if (playersAlive[3])
            document.getElementById('partnerEnemyChoice').src = "images/" + moveOptions[playerChoices[3]] + ".svg"

        if (playersAlive[1])
            document.getElementById('selfEnemyChoice').src = "images/" + moveOptions[playerChoices[1]] + ".svg"

        if (playersAlive[0]) {
            document.getElementById('selfChoiceDiv').style.setProperty('display', 'flex', 'important');
            document.getElementById('selfChoice').src = "images/" + moveOptions[playerChoices[0]] + ".svg"
        }

        // hide choice selection
        document.getElementById('chooseItem').style.setProperty('display', 'none', 'important');

        positionLines();

        // evaluate round
        // all players alive
        if (playersAlive[0] && playersAlive[1] && playersAlive[2] && playersAlive[3]) {
            let selfRes = res2 = GetRPSResult(playerChoices[0], playerChoices[1]);
            let selfEnemyRes = -selfRes;
            let partnerRes = res1 = GetRPSResult(playerChoices[2], playerChoices[3]);
            let partnerEnemyRes = -partnerRes;
            playersAlive[0] = selfRes >= 0;
            playersAlive[1] = selfEnemyRes >= 0;
            playersAlive[2] = partnerRes >= 0;
            playersAlive[3] = partnerEnemyRes >= 0;
        }
        // you dead
        else if (!playersAlive[0] && playersAlive[1] && playersAlive[2] && playersAlive[3]) {
            let partnerRes1 = res2 = GetRPSResult(playerChoices[2], playerChoices[1]);
            let selfEnemyRes = -partnerRes1;
            let partnerRes2 = res1 = GetRPSResult(playerChoices[2], playerChoices[3]);
            let partnerEnemyRes = -partnerRes2;
            playersAlive[1] = selfEnemyRes >= 0;
            playersAlive[2] = partnerRes2 >= 0 && partnerRes2 >= 0;
            playersAlive[3] = partnerEnemyRes >= 0;
        }
        // partner dead
        else if (playersAlive[0] && playersAlive[1] && !playersAlive[2] && playersAlive[3]) {
            let selfRes1 = res2 = GetRPSResult(playerChoices[0], playerChoices[1]);
            let selfEnemyRes = -selfRes1;
            let selfRes2 = res1 = GetRPSResult(playerChoices[0], playerChoices[3]);
            let partnerEnemyRes = -selfRes2;
            playersAlive[0] = selfRes1 >= 0 && selfRes2 >= 0;
            playersAlive[1] = selfEnemyRes >= 0;
            playersAlive[3] = partnerEnemyRes >= 0;
        }
        // your enemy dead
        else if (playersAlive[0] && !playersAlive[1] && playersAlive[2] && playersAlive[3]) {
            let selfRes = res2 = GetRPSResult(playerChoices[0], playerChoices[3]);
            let partnerEnemyRes1 = -selfRes;
            let partnerRes = res1 = GetRPSResult(playerChoices[2], playerChoices[3]);
            let partnerEnemyRes2 = -partnerRes;
            playersAlive[0] = selfRes >= 0;
            playersAlive[2] = partnerRes >= 0;
            playersAlive[3] = partnerEnemyRes1 >= 0 && partnerEnemyRes2 >= 0;
        }
        // partner enemy dead
        else if (playersAlive[0] && playersAlive[1] && playersAlive[2] && !playersAlive[3]) {
            let selfRes = res2 = GetRPSResult(playerChoices[0], playerChoices[1]);
            let selfEnemyRes1 = -selfRes;
            let partnerRes = res1 = GetRPSResult(playerChoices[2], playerChoices[1]);
            let selfEnemyRes2 = -partnerRes;
            playersAlive[0] = selfRes >= 0;
            playersAlive[1] = selfEnemyRes1 >= 0 && selfEnemyRes2 >= 0;
            playersAlive[2] = partnerRes >= 0;
        }

        // two dead
        else if (playersAlive[0] + playersAlive[1] + playersAlive[2] + playersAlive[3] == 2) {
            // there shouldn't be a case where two on the same team are alive as the round would be reset
            let teamAlive = playersAlive[0] ? 0 : 2;
            let enemyAlive = playersAlive[1] ? 1 : 3;
            let teamRes = res1 = res2 = GetRPSResult(playerChoices[teamAlive], playerChoices[enemyAlive]);
            let enemyRes = -teamRes;
            playersAlive[teamAlive] = teamRes >= 0;
            playersAlive[enemyAlive] = enemyRes >= 0;
        }
        recolorLines();

        if (!playersAlive[1] && !playersAlive[3]) {
            winRound();
        }

        if (!playersAlive[0] && !playersAlive[2]) {
            loseRound();
        }

        resultsSecondsRemaining = 3;
        let resultsInterval = setInterval(() => {
            if (--resultsSecondsRemaining == 0) {
                if (teamWins >= starsToWin) {
                    reset();
                    document.getElementById('resultsImage').src = "images/win.svg"
                    SetActiveScreen("results");
                }
                else if (enemyWins >= starsToWin) {
                    reset();
                    document.getElementById('resultsImage').src = "images/lose.svg"
                    SetActiveScreen("results");
                }
                else {
                    // start next round
                    if (aiMode)
                        startNextRound();
                }

                clearInterval(resultsInterval);
                resultsInterval = null;
            }
        }, 1000);
    }

    function reset() {
        document.getElementById('team_star_1').src = "images/star_empty.svg";
        document.getElementById('team_star_2').src = "images/star_empty.svg";
        document.getElementById('enemy_star_1').src = "images/star_empty.svg";
        document.getElementById('enemy_star_2').src = "images/star_empty.svg";
        enemyWins = 0;
        teamWins = 0;
        playersAlive = [true, true, true, true];
        moveChosen = false;
    }

    function winRound() {
        playersAlive = [true, true, true, true];
        teamWins++;
        if (teamWins > 0) {
            document.getElementById('team_star_1').src = "images/star_filled.svg";
        }
        if (teamWins > 1) {
            document.getElementById('team_star_2').src = "images/star_filled.svg";
        }
    }

    function loseRound() {
        playersAlive = [true, true, true, true];
        enemyWins++;
        if (enemyWins > 0) {
            document.getElementById('enemy_star_1').src = "images/star_filled.svg";
        }
        if (enemyWins > 1) {
            document.getElementById('enemy_star_2').src = "images/star_filled.svg";
        }
    }

    let countdownInterval = null;
    function SetActiveScreen(elemId) {
        document.getElementById("matchmaking").style.display = 'none';
        document.getElementById("searching").style.display = 'none';
        document.getElementById("game").style.display = 'none';
        document.getElementById("results").style.display = 'none';
        document.getElementById(elemId).style.display = 'unset';

        // perform necessary operations on screen change
        switch (elemId) {
            case "matchmaking":
                break;
            case "searching":
                document.getElementById("waitingQuip").innerText = quips[quips.length * Math.random() | 0] + "... Just waiting for your friend to join the fray!(1 / 4)";
                document.getElementById("searchingCodeButton").style.display = 
                    document.getElementById("searchingCodeLabel").style.display = document.getElementById("friendIdInput").value.length == 0 ? 'none' : 'visible';
                break;
            case "game":
                reset();
                startNextRound();
                positionLines();
                break;
        }
    }
    document.getElementById("scrollContainer").addEventListener("scroll", (event) => {
        if (!ticking) {
            window.requestAnimationFrame(() => {
                fitLineSVGsToWindow();
                ticking = false;
            });

            ticking = true;
        }
    });
    window.addEventListener('resize', fitLineSVGsToWindow);
    function fitLineSVGsToWindow() {
        // partner line
        let partnerLineSVG = document.getElementById("partnerLineSVG");
        partnerLineSVG.setAttribute("width", window.innerWidth * 0.95);
        partnerLineSVG.setAttribute("height", window.innerHeight * 0.95);
        
        // self line
        let selfLineSVG = document.getElementById("selfLineSVG");
        selfLineSVG.setAttribute("width", window.innerWidth * 0.95);
        selfLineSVG.setAttribute("height", window.innerHeight * 0.95);
        
        positionLines();
    };
    fitLineSVGsToWindow();

    function clearLineColors() {
        // get lines
        let partnerLine = document.getElementById("partnerLine");
        let selfLine = document.getElementById("selfLine");
        let lines = [partnerLine, selfLine];

        for (let i = 0; i < lines.length; ++i) {
            lines[i].setAttribute("stroke", "white");
        }
    }

    function recolorLines() {
        // get lines
        let partnerLine = document.getElementById("partnerLine");
        let selfLine = document.getElementById("selfLine");
        let lines = [partnerLine, selfLine];
        let colors = ["red", "white", "green"];

        for (let i = 0; i < lines.length; ++i) {
            lines[i].setAttribute("stroke", colors[(i == 0 ? res1 : res2) + 1]);
        }
    }

    function positionLines() {
        // get divs
        let partnerChoiceDiv      = document.getElementById("partnerChoiceDiv");
        let partnerEnemyChoiceDiv = document.getElementById("partnerEnemyChoiceDiv");
        let selfChoiceDiv         = document.getElementById("chooseItem");

        if (selfChoiceDiv.style.display === 'none')
            selfChoiceDiv = document.getElementById("selfChoiceItemDiv");

        let selfEnemyChoiceDiv = document.getElementById("selfEnemyChoiceDiv").querySelector(".item");
        lineDivs = [playersAlive[2] ? partnerChoiceDiv : selfChoiceDiv,
                    playersAlive[3] ? partnerEnemyChoiceDiv : selfEnemyChoiceDiv,
                    playersAlive[0] ? selfChoiceDiv : partnerChoiceDiv,
                    playersAlive[1] ? selfEnemyChoiceDiv : partnerEnemyChoiceDiv];

        // get lines
        let partnerLine = document.getElementById("partnerLine");
        let selfLine = document.getElementById("selfLine");
        let lines = [partnerLine, selfLine];

        for (let i = 0; i < lines.length; ++i) {
            // get div rects (viewport-relative positions)
            let rect1 = lineDivs[i * 2].getBoundingClientRect();
            let rect2 = lineDivs[i * 2 + 1].getBoundingClientRect();
            
            // calc div centers
            // TODO: why off by 24?
            let div1CenterX = rect1.right - 24;
            let div1CenterY = rect1.top + rect1.height / 2;
            let div2CenterX = rect2.left - 24;
            let div2CenterY = rect2.top + rect2.height / 2;
            
            // connect line ends to div centers
            lines[i].setAttribute("x1", div1CenterX + 20);
            lines[i].setAttribute("y1", div1CenterY);
            lines[i].setAttribute("x2", div2CenterX - 20);
            lines[i].setAttribute("y2", div2CenterY);
        }
    }

    function makeAiChoices() {
        for (let i = 1; i < 4; ++i)
            playerChoices[i] = moveOptions.length * Math.random() | 0;
    }

    function makeChoice(moveInd) {
        if (countdownInterval && !moveChosen) {
            playerChoices[0] = moveInd;
            if (playersAlive[0]) {
                document.getElementById('chooseItem').style.setProperty('display', 'none', 'important');
                document.getElementById('selfChoiceDiv').style.setProperty('display', 'flex', 'important');
                document.getElementById('selfChoice').src = "images/checkmark_icon.svg"
            }
            if (aiMode) {
                makeAiChoices();
                revealChoices();
            }
            else {
                connection.invoke("SubmitMove", "" + moveInd)
                    .catch(err => console.error("Error submitting action: " + err));
                positionLines();
            }
            moveChosen = true;
        }
    }

    document.getElementById("GUID").addEventListener("click", function () {
        navigator.clipboard.writeText(document.getElementById("GUID-TEXT").innerText);
    });

    document.getElementById("GUID-2").addEventListener("click", function () {
        navigator.clipboard.writeText(document.getElementById("GUID-TEXT-2").innerText);
    });

    document.getElementById("rockChoice").addEventListener("click", function () {
        makeChoice(0);
    });

    document.getElementById("paperChoice").addEventListener("click", function () {
        makeChoice(1);
    });

    document.getElementById("scissorsChoice").addEventListener("click", function () {
        makeChoice(2);
    });

    document.getElementById("fightAIBtn").addEventListener("click", function () {
        aiMode = true;
        SetActiveScreen("game");
    });

    document.getElementById("playAgainBtn").addEventListener("click", function () {
        SetActiveScreen("matchmaking");
    });

    document.getElementById("findGameBtn").addEventListener("click", function () {
        aiMode = false;

        // start matchmaking
        SetActiveScreen("searching");
        connection.invoke("StartMatchmaking", document.getElementById("friendIdInput").value, document.getElementById("nameInput").value)
            .catch(err => console.error("Error starting matchmaking: " + err));
    });

    // listen for rps keyboard input
    document.addEventListener('keydown', function (event) {
        if (event.code == 'KeyR') {
            makeChoice(0);
        }
        else if (event.code == 'KeyP') {
            makeChoice(1);
        }
        else if (event.code == 'KeyS') {
            makeChoice(2);
        }
    });

    // listen for moves
    connection.on("ReceiveMoves", function (playerMoves) {
        for (let i = 0; i < playerMoves.length; ++i) {
            playerChoices[i] = playerMoves[i];
            if(!moveOptions[playerChoices[i]]){
                console.log(i + " " + playerChoices[i]);
            }
        }
        revealChoices();
    });

    // start next round
    connection.on("StartRound", function () {
        startNextRound();
    });

    connection.on("UpdateMatchmakingProgress", function (numPlayersInRoom) {
        curText = document.getElementById("waitingQuip").innerText;
        document.getElementById("waitingQuip").innerText = curText.substr(0, curText.length - 7) + "(" + numPlayersInRoom + " / 4)";
    });

    connection.on("PlayerMoved", function (playerCode) {


        playerIndex = playerMap[playerCode];
        console.log(playerCode);
        console.log(playerIndex);
        // reveal player choices
        if (playerIndex == 2) {
            document.getElementById("partnerChoiceWait").style.setProperty('display', 'none', 'important');
            document.getElementById("partnerChoice").style.setProperty('display', 'flex', 'important');
            document.getElementById('partnerChoice').src = "images/checkmark_icon.svg"
        }

        if (playerIndex == 3) {
            document.getElementById("partnerEnemyChoiceWait").style.setProperty('display', 'none', 'important');
            document.getElementById("partnerEnemyChoice").style.setProperty('display', 'flex', 'important');
            document.getElementById('partnerEnemyChoice').src = "images/checkmark_icon.svg"
        }

        if (playerIndex == 1){
            document.getElementById("selfEnemyChoiceWait").style.setProperty('display', 'none', 'important');
            document.getElementById("selfEnemyChoice").style.setProperty('display', 'flex', 'important');
            document.getElementById('selfEnemyChoice').src = "images/checkmark_icon.svg"
        }
    });

    // listen for moves
    connection.on("log", function (playerMoves) {
        console.log(playerMoves);
    });

    connection.on("JoinRoom", function (partnerName, selfEnemyName, partnerEnemyName, selfCode, partnerCode, selfEnemyCode, partnerEnemyCode) {
        // display room info
        document.getElementById("selfEnemyName").innerText = selfEnemyName;
        document.getElementById("partnerName").innerText = partnerName;
        document.getElementById("partnerEnemyName").innerText = partnerEnemyName;
        playerMap[selfCode] = 0;
        playerMap[partnerCode] = 2;
        playerMap[selfEnemyCode] = 1;
        playerMap[partnerEnemyCode] = 3;
        SetActiveScreen("game");
    });

</script>
